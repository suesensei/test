<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Responsive Alphabet Invaders</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #canvas { display: block; background: #000; width: 100%; height: 100%; touch-action: none; }
    #startScreen {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex; align-items: center; justify-content: center;
      z-index: 2;
    }
    #startButton {
      padding: 20px 40px; font-size: 24px; cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="startScreen"><button id="startButton">START</button></div>
  <canvas id="canvas"></canvas>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // レスポンシブ対応
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      ship.y = canvas.height - ship.h - 10;
    }
    window.addEventListener('resize', resizeCanvas);

    // レターグループ分割
    const groups = [
      'ABCDEFG'.split(''),
      'HIJKLMNOP'.split(''),
      'QRSTUVWXYZ'.split('')
    ];

    // サウンドロード
    const sounds = {};
    groups.flat().forEach(ch => { sounds[ch] = new Audio(ch.toLowerCase() + '.mp3'); });
    const wrongSound = new Audio('wrong.mp3');

    let stage = 0, globalNext = 0, wrongCount = 0, gameOver = false;
    let aliens = [], startTime;

    // 自機 (縦長)
    const ship = { x: window.innerWidth / 2, y: window.innerHeight - 70, w: 20, h: 60 };

    // ボール（ミサイル改めボール）
    const ball = { x: 0, y: 0, r: 8, active: false, bouncing: false, speed: 16, vx: 0, vy: 0, gravity: 0.5 };

    // エイリアン移動設定
    let alienVelocity = 1.2;
    const dropDistance = 20;

    function loadStage() {
      // ボールリセット
      ball.active = false;
      ball.bouncing = false;

      if (stage >= groups.length) {
        gameOver = true;
        return;
      }
      const arr = groups[stage];
      aliens = [];
      if (stage === 0) startTime = Date.now();
      const rows = 2;
      const perRow = Math.ceil(arr.length / rows);
      arr.forEach((letter, i) => {
        const row = Math.floor(i / perRow);
        const y = 50 + row * 80; // 行間少し広く
        let x;
        const minDist = 100; // 重なり防止
        do {
          x = Math.random() * (canvas.width - 100) + 50;
        } while (aliens.some(a => Math.abs(a.x - x) < minDist));
        aliens.push({ letter, x, y, rx: 40, ry: 60 }); // 風船形: 横40px 縦60px
      });
    }

    function moveAliens() {
      let hitEdge = false;
      aliens.forEach(a => {
        a.x += alienVelocity;
        if (a.x + a.rx >= canvas.width || a.x - a.rx <= 0) hitEdge = true;
      });
      if (hitEdge) {
        alienVelocity *= -1;
        aliens.forEach(a => a.y += dropDistance);
      }
    }

    function drawGameOver() {
      const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
      ctx.fillStyle = 'white';
      ctx.font = '32px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(`CLEAR! ${elapsed}秒  ミス: ${wrongCount}`, canvas.width / 2, canvas.height / 2);
    }

    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ship.y = canvas.height - ship.h - 10;

      // エイリアン移動・描画
      moveAliens();
      aliens.forEach(a => {
        // 風船形エイリアン
        ctx.fillStyle = '#0f0';
        ctx.beginPath();
        ctx.ellipse(a.x, a.y, a.rx, a.ry, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#000';
        ctx.font = '32px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(a.letter, a.x, a.y);
      });

      // 自機描画
      ctx.fillStyle = '#0af';
      ctx.fillRect(ship.x - ship.w / 2, ship.y - ship.h / 2, ship.w, ship.h);

      // ボール処理
      if (ball.active) {
        if (ball.bouncing) {
          ball.vy += ball.gravity;
          ball.x += ball.vx;
          ball.y += ball.vy;
          ctx.fillStyle = 'yellow';
          ctx.beginPath();
          ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
          ctx.fill();
          // 画面外で消去
          if (ball.x < 0 || ball.x > canvas.width || ball.y > canvas.height) {
            ball.active = false;
            ball.bouncing = false;
          }
        } else {
          // 飛んでいくボール
          ball.y -= ball.speed;
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
          ctx.fill();
          if (ball.y < 0) ball.active = false;
          // 衝突判定
          aliens.some((a, i) => {
            const dx = a.x - ball.x;
            const dy = a.y - ball.y;
            const dist = Math.hypot(dx, dy);
            // 風船とボールの当たり判定: 半径簡易
            if (dist < Math.max(a.rx, a.ry)) {
              const expected = groups.flat()[globalNext];
              if (a.letter === expected) {
                sounds[a.letter].play();
                aliens.splice(i, 1);
                globalNext++;
                if (aliens.length === 0) {
                  stage++;
                  loadStage();
                }
                // バウンス開始
                ball.bouncing = true;
                ball.vy = -12;
                ball.vx = 0;
              } else {
                wrongSound.play();
                wrongCount++;
                ball.active = false;
              }
              return true;
            }
            return false;
          });
        }
      }

      if (gameOver) drawGameOver(); else requestAnimationFrame(loop);
    }

    // ゲーム開始
    function startGame() {
      document.getElementById('startScreen').style.display = 'none';
      resizeCanvas();
      loadStage();
      requestAnimationFrame(loop);
    }
    document.getElementById('startButton').addEventListener('click', startGame);

    // 入력処理
    let isDragging = false, startOnShip = false;
    canvas.addEventListener('pointerdown', e => {
      const mx = e.offsetX, my = e.offsetY;
      if (
        mx >= ship.x - ship.w / 2 && mx <= ship.x + ship.w / 2 &&
        my >= ship.y - ship.h / 2 && my <= ship.y + ship.h / 2
      ) {
        startOnShip = true;
        canvas.setPointerCapture(e.pointerId);
      }
    });
    canvas.addEventListener('pointermove', e => {
      if (startOnShip) {
        isDragging = true;
        ship.x = e.offsetX;
      }
    });
    canvas.addEventListener('pointerup', e => {
      if (startOnShip && !isDragging && !ball.active && !gameOver) {
        ball.active = true;
        ball.x = ship.x;
        ball.y = ship.y - ship.h / 2;
      }
      isDragging = false;
      startOnShip = false;
      canvas.releasePointerCapture(e.pointerId);
    });

    // 初期表示
    resizeCanvas();
  </script>
</body>
</html>
